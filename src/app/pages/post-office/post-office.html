<div class="card">
    <h2 class="page-title mb-3">Post Office Management</h2>

    <div class="d-flex flex-wrap align-items-center mb-3 gap-2">

        <!-- Left: search + filters -->
        <div class="d-flex flex-wrap align-items-center gap-2 flex-grow-1">
            <app-search-bar [tooltipText]="'Search by action name'" [value]="queryParams.SearchText || ''"
                [searchByOptions]="searchByOptions" [searchByValue]="queryParams.SearchBy || ''"
                (valueChange)="onSearch($event)" (typingChange)="onTypingChange($event)"
                (searchByChange)="onSearchByChange($event)">
            </app-search-bar>
            <app-filter-by [filters]="filterOptions" [activeFilters]="activeFilters" [clearSignal]="clearSignal"
                (filterChange)="onFilterChange($event)">
            </app-filter-by>


        </div>

        <!-- Actions -->
        <div class="actions ms-auto d-flex flex-wrap gap-2">
            <button type="button" class="btn-action btn-outline">
                <mat-icon class="msr">file_download</mat-icon>
                <span class="btn-text">Export</span>
            </button>

            <button type="button" class="btn-action btn-primary" (click)="openAddDialog()">
                <mat-icon class="msr">add</mat-icon>
                <span class="btn-text">Add</span>
            </button>
        </div>
    </div>

    @let entries = activeFilters | keyvalue;

    @if (entries.length) {
    <div class="active-filters d-flex flex-wrap align-items-center gap-2 mb-3">
        @for (entry of entries; track entry.key) {
        @for (val of entry.value; track val) {
        <span class="filter-chip">
            {{ val }}
            <button type="button" class="btn-clear" (click)="removeFilter(entry.key, val)">Ã—</button>
        </span>
        }
        }
        <button type="button" class="btn btn-sm btn-outline-secondary ms-2" (click)="clearAllFilters()">
            Clear all
        </button>
    </div>
    }

    <div class="table-responsive position-relative">
        @if ((loading$ | async) || isSearching) {
        <div class="progress position-absolute top-0 start-0 end-0" role="progressbar" aria-label="Loading"
            style="z-index: 10; height: 4px; background-color: transparent;">
            <div class="table-premium-loader"></div>
        </div>
        }

        <table class="table align-middle">
            <thead class="table-light">
                <tr>
                    <th appSortableColumn="postOfficeName" [sortBy]="queryParams.SortBy"
                        [sortOrder]="queryParams.SortOrder" (sortChange)="onSortChange($event)">
                        Post Office Name
                    </th>
                    <th>
                        Zip Codes
                    </th>
                    <th appSortableColumn="active" [sortBy]="queryParams.SortBy" [sortOrder]="queryParams.SortOrder"
                        (sortChange)="onSortChange($event)">
                        Status
                    </th>
                    <th>Created By</th>
                    <th>Modified By</th>
                    <th>Deleted By</th>
                    <th>Action</th>
                </tr>
            </thead>

            <tbody>
                @for (item of postOffices; track item.postOfficeId) {
                <tr>
                    <td>{{ item.postOfficeName }}</td>

                    <td>
                        @if (item.zipCodes.length) {
                        @let sortedZips = sortZipCodes(item.zipCodes);
                        <div class="zip-list">
                            @for (zip of sortedZips.slice(0, 3); track zip.zipCodeId) {
                            <span class="zip-chip" [class.zip-deleted]="zip.deleted">{{ zip.zipCode }}</span>
                            }

                            @if (sortedZips.length > 3) {
                            <span class="zip-more" [matMenuTriggerFor]="zipMenu"
                                [matMenuTriggerData]="{zips: sortedZips}">
                                +{{ sortedZips.length - 3 }} more
                            </span>
                            }
                        </div>
                        } @else {
                        <span>-</span>
                        }
                    </td>

                    <td><app-status-badge [item]="item"></app-status-badge></td>

                    <td>
                        @if (item.createdUser || item.createdDate) {
                        <div class="d-flex flex-column">
                            <small>{{ item.createdUser || '-' }}</small>
                            <small>{{ utilityService.formatDateTimeDdMmYyyy12h(item.createdDate) ||
                                '-'
                                }}</small>
                        </div>
                        } @else {
                        <span>-</span>
                        }
                    </td>

                    <td>
                        @if ((item.modifiedUser || item.modifiedDate) && !item.deleted) {
                        <div class="d-flex flex-column">
                            <small>{{ item.modifiedUser || '-' }}</small>
                            <small>{{ utilityService.formatDateTimeDdMmYyyy12h(item.modifiedDate) ||
                                '-' }}</small>
                        </div>
                        } @else {
                        <span>-</span>
                        }
                    </td>

                    <td>
                        @if (item.deleted && (item.deletedUser || item.deletedDate)) {
                        <div class="d-flex flex-column">
                            <small>{{ item.deletedUser || '-' }}</small>
                            <small>{{ utilityService.formatDateTimeDdMmYyyy12h(item.deletedDate) ||
                                '-'
                                }}</small>
                        </div>
                        } @else {
                        <span>-</span>
                        }
                    </td>

                    <td class="action-cell">
                        <button mat-icon-button class="menu-trigger" [matMenuTriggerFor]="rowMenu"
                            aria-label="More actions">
                            <mat-icon class="msr">more_vert</mat-icon>
                        </button>

                        <mat-menu #rowMenu="matMenu" class="row-menu" xPosition="before" yPosition="below">
                            <button mat-menu-item (click)="openEditDialog(item)">
                                <mat-icon class="msr-edit">edit</mat-icon>
                                <span>Edit</span>
                            </button>
                            @if (!item.deleted) {
                            <button mat-menu-item (click)="onSuspend(item)">
                                <mat-icon [ngClass]="item.active ? 'msr-delete' : 'msr-restore'">{{ item.active ?
                                    'cancel' : 'check_circle' }}</mat-icon>
                                <span>{{ item.active ? 'Suspend' : 'Reinstate' }}</span>
                            </button>
                            }
                            @if (!item.deleted) {
                            <button mat-menu-item (click)="onDelete(item)">
                                <mat-icon class="msr-delete">delete</mat-icon>
                                <span>Delete</span>
                            </button>
                            }

                            @if (item.deleted) {
                            <button mat-menu-item (click)="onRestore(item)">
                                <mat-icon class="msr-restore">restore</mat-icon>
                                <span>Restore</span>
                            </button>
                            }
                        </mat-menu>
                    </td>
                </tr>
                }

                @if (postOffices.length === 0) {
                <tr>
                    <td colspan="6" class="text-center p-3">
                        @if (loading$ | async) {
                        <small class="loading-text">Please wait...</small>
                        } @else {
                        <small class="no-data-text">No data found</small>
                        }
                    </td>
                </tr>
                }
            </tbody>
        </table>
    </div>

    <app-pagination [totalItems]="totalCount" [pageSize]="pageSize" [pageSizes]="pageSizes" [currentPage]="currentPage"
        (paginationChange)="onPaginationChange($event)">
    </app-pagination>
</div>

<mat-menu #zipMenu="matMenu" class="zip-overview-menu">
    <ng-template matMenuContent let-zips="zips">
        <div class="zip-menu-container" (click)="$event.stopPropagation()">
            @for (zip of zips; track zip.zipCodeId) {
            <span class="zip-chip" [class.zip-deleted]="zip.deleted">{{ zip.zipCode }}</span>
            }
        </div>
    </ng-template>
</mat-menu>