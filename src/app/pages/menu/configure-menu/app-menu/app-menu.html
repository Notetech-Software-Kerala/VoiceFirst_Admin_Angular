<div class="menu-container p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="page-title m-0">App Menu Management</h2>
        <button mat-raised-button color="primary" (click)="onSave()">
            <mat-icon>save</mat-icon> Save Order
        </button>
    </div>

    <div class="tree-wrapper">
        <div cdkDropList [cdkDropListData]="menuNodes" [id]="'root-list'" [cdkDropListConnectedTo]="connectedDropLists"
            (cdkDropListDropped)="drop($event)" class="menu-list root-list" [cdkDropListSortingDisabled]="false">
            @for (node of menuNodes; track node.menuId) {
            <div cdkDrag [cdkDragData]="node" class="menu-node-wrapper">

                <!-- Use ng-container to pass node to template -->
                <ng-container *ngTemplateOutlet="nodeTemplate; context: { $implicit: node }"></ng-container>

                <!-- Placeholder preview while dragging -->
                <div *cdkDragPlaceholder class="menu-placeholder"></div>
            </div>
            }
        </div>
    </div>
</div>

<ng-template #nodeTemplate let-node>
    <div class="menu-node-content" [class.has-children]="node.children.length > 0">
        <div class="node-handle" cdkDragHandle>
            <mat-icon class="drag-icon">drag_indicator</mat-icon>
        </div>

        <div class="node-info d-flex align-items-center flex-grow-1 gap-3">
            <div class="node-icon-wrapper">
                <!-- Check if icon is font awesome / feather or mat-icon -->
                <i *ngIf="false" [class]="'feather icon-' + node.icon"></i>
                <mat-icon>{{ node.icon }}</mat-icon>
            </div>

            <div class="node-details">
                <h6 class="m-0 fw-bold">{{ node.menuName }}</h6>
                <small class="text-muted">{{ node.route }}</small>
            </div>
        </div>

        <div class="node-actions d-flex gap-2">
            @if (node.children.length > 0 || !node.route) {
            <button mat-icon-button (click)="toggleExpand(node)">
                <mat-icon>{{ node.isExpanded ? 'expand_less' : 'expand_more' }}</mat-icon>
            </button>
            }
            <button mat-icon-button color="primary">
                <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button color="warn">
                <mat-icon>delete</mat-icon>
            </button>
        </div>
    </div>

    <!-- Nested Drop List -->
    @if (node.isExpanded && !node.route) {
    <div class="node-children" cdkDropList [cdkDropListData]="node.children" [id]="'list-' + node.appMenuId"
        [cdkDropListConnectedTo]="connectedDropLists" (cdkDropListDropped)="drop($event)"
        [cdkDropListSortingDisabled]="false">

        @for (child of node.children; track child.menuId) {
        <div cdkDrag [cdkDragData]="child" class="menu-node-wrapper">
            <ng-container *ngTemplateOutlet="nodeTemplate; context: { $implicit: child }"></ng-container>

            <!-- Placeholder for drag preview -->
            <div *cdkDragPlaceholder class="menu-placeholder"></div>
        </div>
        }
    </div>
    }
</ng-template>